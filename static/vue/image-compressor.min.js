!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.ImageCompressor=t()}(this,function(){"use strict";var e,t=(function(e){!function(t){var r=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,n=t.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),a=n&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),i=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,o=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,l=(n||i)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(e){var t,r,l,u,c,s,f,h,d;if(!(t=e.match(o)))throw new Error("invalid data URI");for(r=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),l=!!t[4],u=e.slice(t[0].length),c=l?atob(u):decodeURIComponent(u),s=new ArrayBuffer(c.length),f=new Uint8Array(s),h=0;h<c.length;h+=1)f[h]=c.charCodeAt(h);return n?new Blob([a?f:s],{type:r}):((d=new i).append(s),d.getBlob(r))};t.HTMLCanvasElement&&!r.toBlob&&(r.mozGetAsFile?r.toBlob=function(e,t,n){var a=this;setTimeout(function(){n&&r.toDataURL&&l?e(l(a.toDataURL(t,n))):e(a.mozGetAsFile("blob",t))})}:r.toDataURL&&l&&(r.toBlob=function(e,t,r){var n=this;setTimeout(function(){e(l(n.toDataURL(t,r)))})})),e.exports?e.exports=l:t.dataURLtoBlob=l}(window)}(e={exports:{}},e.exports),e.exports),r=Object.prototype.toString,n={checkOrientation:!0,maxWidth:1/0,maxHeight:1/0,minWidth:0,minHeight:0,width:void 0,height:void 0,quality:.8,mimeType:"auto",convertSize:5e6,beforeDraw:null,drew:null,success:null,error:null},a=/^image\/.+$/;function i(e){return a.test(e)}var o=String.fromCharCode;var l=window.btoa;function u(e){var t=new DataView(e),r=void 0,n=void 0,a=void 0,i=void 0;if(255===t.getUint8(0)&&216===t.getUint8(1))for(var l=t.byteLength,u=2;u<l;){if(255===t.getUint8(u)&&225===t.getUint8(u+1)){a=u;break}u+=1}if(a){var c=a+10;if("Exif"===function(e,t,r){var n="",a=void 0;for(r+=t,a=t;a<r;a+=1)n+=o(e.getUint8(a));return n}(t,a+4,4)){var s=t.getUint16(c);if(((n=18761===s)||19789===s)&&42===t.getUint16(c+2,n)){var f=t.getUint32(c+4,n);f>=8&&(i=c+f)}}}if(i){var h=t.getUint16(i,n),d=void 0,m=void 0;for(m=0;m<h;m+=1)if(d=i+12*m+2,274===t.getUint16(d,n)){d+=8,r=t.getUint16(d,n),t.setUint16(d,1,n);break}}return r}var c=/\.\d*(?:0|9){12}\d*$/i;function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e11;return c.test(e)?Math.round(e*t)/t:e}var f=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},h=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},m=window,v=m.ArrayBuffer,b=m.FileReader,g=window.URL||window.webkitURL,w=/\.\w+$/;return function(){function e(t,r){f(this,e),this.result=null,t&&this.compress(t,r)}return h(e,[{key:"compress",value:function(e,a){var c=this,f=new Image;return a=d({},n,a),v||(a.checkOrientation=!1),new Promise(function(t,n){if((c=e)instanceof Blob||"[object Blob]"===r.call(c)){var c,s=e.type;if(i(s))if(g||b){if(g&&!a.checkOrientation)t({url:g.createObjectURL(e)});else if(b){var f=new b,h=a.checkOrientation&&"image/jpeg"===s;f.onload=function(e){var r=e.target.result;t(h?d({url:function(e,t){var r=new Uint8Array(e),n=r.length,a="",i=void 0;for(i=0;i<n;i+=1)a+=o(r[i]);return"data:"+t+";base64,"+l(a)}(r,s)},function(e){var t=0,r=1,n=1;switch(e){case 2:r=-1;break;case 3:t=-180;break;case 4:n=-1;break;case 5:t=90,n=-1;break;case 6:t=90;break;case 7:t=90,r=-1;break;case 8:t=-90}return{rotate:t,scaleX:r,scaleY:n}}(u(r))):{url:r})},f.onabort=n,f.onerror=n,h?f.readAsArrayBuffer(e):f.readAsDataURL(e)}}else n(new Error("The current browser does not support image compression."));else n(new Error("The first argument must be an image File or Blob object."))}else n(new Error("The first argument must be a File or Blob object."))}).then(function(t){return new Promise(function(r,n){f.onload=function(){return r(d({},t,{naturalWidth:f.naturalWidth,naturalHeight:f.naturalHeight}))},f.onabort=n,f.onerror=n,f.alt=e.name,f.src=t.url})}).then(function(r){var n=r.naturalWidth,o=r.naturalHeight,l=r.rotate,u=void 0===l?0:l,h=r.scaleX,d=void 0===h?1:h,m=r.scaleY,v=void 0===m?1:m;return new Promise(function(r){var l=document.createElement("canvas"),h=l.getContext("2d"),m=n/o,b=Math.max(a.maxWidth,0)||1/0,g=Math.max(a.maxHeight,0)||1/0,w=Math.max(a.minWidth,0)||0,p=Math.max(a.minHeight,0)||0,y=n,U=o;if(b<1/0&&g<1/0?g*m>b?g=b/m:b=g*m:b<1/0?g=b/m:g<1/0&&(b=g*m),w>0&&p>0?p*m>w?p=w/m:w=p*m:w>0?p=w/m:p>0&&(w=p*m),a.width>0)U=(y=a.width)/m;else if(a.height>0){y=(U=a.height)*m}var B=-(y=Math.min(Math.max(y,w),b))/2,M=-(U=Math.min(Math.max(U,p),g))/2,x=y,T=U;if(Math.abs(u)%180==90){var k={width:U,height:y};y=k.width,U=k.height}l.width=s(y),l.height=s(U),i(a.mimeType)||(a.mimeType=e.type);var A="transparent";e.size>a.convertSize&&"image/png"===a.mimeType&&(A="#fff",a.mimeType="image/jpeg"),h.fillStyle=A,h.fillRect(0,0,y,U),h.save(),h.translate(y/2,U/2),h.rotate(u*Math.PI/180),h.scale(d,v),a.beforeDraw&&a.beforeDraw.call(c,h,l),h.drawImage(f,Math.floor(s(B)),Math.floor(s(M)),Math.floor(s(x)),Math.floor(s(T))),a.drew&&a.drew.call(c,h,l),h.restore();var L=function(e){r({naturalWidth:n,naturalHeight:o,result:e})};l.toBlob?l.toBlob(L,a.mimeType,a.quality):L(t(l.toDataURL(a.mimeType,a.quality)))})}).then(function(t){var r=t.naturalWidth,n=t.naturalHeight,o=t.result;if(g&&!a.checkOrientation&&g.revokeObjectURL(f.src),o)if(o.size>e.size&&a.mimeType===e.type&&!(a.width>r||a.height>n||a.minWidth>r||a.minHeight>n))o=e;else{var l=new Date;o.lastModified=l.getTime(),o.lastModifiedDate=l,o.name=e.name,o.name&&o.type!==e.type&&(o.name=o.name.replace(w,function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=i(e)?e.substr(6):"";return"jpeg"===r&&(r="jpg"),r&&t&&(r="."+r),r}(o.type)))}else o=e;return c.result=o,a.success&&a.success.call(c,o),Promise.resolve(o)}).catch(function(e){if(!a.error)throw e;a.error.call(c,e)})}}]),e}()});